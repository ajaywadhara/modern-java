# Java 18-21 Features

## Virtual Threads (Java 21)

```java
// BEFORE: Platform threads
ExecutorService executor = Executors.newFixedThreadPool(100);
executor.submit(() -> handleRequest(request));

// AFTER: Virtual threads
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    executor.submit(() -> handleRequest(request));
}

// Direct creation
Thread.startVirtualThread(() -> handleRequest(request));
```

**When to use:**
- I/O-bound tasks (HTTP, DB, file operations)
- High concurrency (thousands of requests)

**When NOT to use:**
- CPU-bound tasks
- Code with synchronized blocks (may pin carrier thread)

---

## Pattern Matching for switch (Java 21)

```java
// BEFORE: if-else chain
if (obj instanceof Integer i) { return "int: " + i; }
else if (obj instanceof String s) { return "str: " + s; }
else if (obj instanceof Double d) { return "dbl: " + d; }

// AFTER: switch expression
return switch (obj) {
    case Integer i -> "int: " + i;
    case String s -> "str: " + s;
    case Double d -> "dbl: " + d;
    default -> "unknown";
};

// With guards
return switch (obj) {
    case String s when s.length() > 10 -> "long: " + s;
    case String s -> "string: " + s;
    default -> "other";
};
```

---

## Record Patterns (Java 21)

```java
record Point(int x, int y) {}
record Rectangle(Point upperLeft, Point lowerRight) {}

// Deconstruct in instanceof
if (obj instanceof Point(int x, int y)) {
    System.out.println("x=" + x + ", y=" + y);
}

// Nested patterns
if (obj instanceof Rectangle(Point(int x1, int y1), Point(int x2, int y2))) {
    int width = x2 - x1;
    int height = y2 - y1;
}

// In switch
return switch (obj) {
    case Point(int x, int y) -> "Point(" + x + "," + y + ")";
    case Rectangle r -> "Rectangle";
    default -> "Unknown";
};
```

---

## Sequenced Collections (Java 21)

```java
// BEFORE: Different methods
list.get(0);
list.get(list.size() - 1);
deque.getFirst();
deque.getLast();

// AFTER: Unified API
list.getFirst();
list.getLast();
list.addFirst(e);
list.addLast(e);
list.removeFirst();
list.removeLast();
list.reversed();
```

---

## String Templates (Withdrawn — do NOT use)

> ⚠️ **JEP 430 was withdrawn.** String templates were preview in Java 21 and 22, then **removed in Java 23** and not scheduled for any future release. Do not use `STR."..."` syntax.

**Use text blocks + `formatted()` instead (Java 15+, final):**

```java
// Safe alternative: text block with formatted()
String msg = "Hello %s, you have %d messages".formatted(name, count);

String json = """
    {
        "name": "%s",
        "age": %d
    }
    """.formatted(user.name(), user.age());
```

---

## Scoped Values (Java 25 Preview, Final in 25)

```java
// BEFORE: ThreadLocal
private static final ThreadLocal<User> currentUser = new ThreadLocal<>();

void processRequest() {
    currentUser.set(user);
    try {
        doWork();
    } finally {
        currentUser.remove();
    }
}

// AFTER: ScopedValue
private static final ScopedValue<User> CURRENT_USER = ScopedValue.create();

void processRequest() {
    ScopedValue.where(CURRENT_USER, user)
        .run(() -> doWork());
}

void doWork() {
    User user = CURRENT_USER.get(); // Available anywhere in call chain
}
```

---

## Structured Concurrency (Preview)

```java
// BEFORE: Unstructured
Future<User> userFuture = executor.submit(() -> fetchUser(id));
Future<List<Order>> ordersFuture = executor.submit(() -> fetchOrders(id));
User user = userFuture.get();

// AFTER: Structured
try (var scope = new StructuredTaskScope.ShutdownOnFailure()) {
    var userTask = scope.fork(() -> fetchUser(id));
    var ordersTask = scope.fork(() -> fetchOrders(id));
    
    scope.join();
    scope.throwIfFailed();
    
    User user = userTask.get();
    List<Order> orders = ordersTask.get();
}
```

---

## Pattern Detection

| Legacy Pattern | Detection | Modern Alternative |
|---------------|-----------|-------------------|
| newFixedThreadPool | `Executors\.new(Fixed\|Cached)ThreadPool` | Virtual threads |
| instanceof chain | `if.*instanceof.*else.*instanceof` | switch pattern |
| get(0), get(size-1) | `\.get\(0\)\|\.get\(.*size.*-` | getFirst/getLast |

---

## Version Features

| Version | Features |
|---------|----------|
| 18 | UTF-8 default, Simple web server |
| 19 | Virtual threads (preview), Record patterns (preview) |
| 20 | Scoped values (preview) |
| 21 | Virtual threads (final), Pattern matching switch (final), Record patterns (final), Sequenced collections |
